!function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){const i=n(1);https=n(2),WebSocket=n(3),fs=n(4),net=n(5),crypto=n(6);let s="xiaoping6868.cn";function o(){}function r(){}function h(){}function c(t){for(var e={},n=t.split("\r\n"),i=n[0].split(" "),s=1;s<n.length;s++){var o=n[s].indexOf(": ");o>0&&(e[n[s].slice(0,o)]=n[s].slice(o+2))}return{protocol:i[0],code:parseInt(i[1]),head:e}}o.prototype.append=function(t){this.cache=this.cache?Buffer.concat([this.cache,t]):t},o.prototype.read=function(){if(!this.cache||!this.cache.length)return null;var t=Math.min(this.cache.length,65431),e=function(t,e){if(4!=t.length)return null;var n,i=crypto.createCipher("camellia-256-ofb",s),o=[Buffer.alloc(4)],r=0;(n=i.update(Buffer.from(t)))&&o.push(n),(n=i.update(e))&&o.push(n),(n=i.final())&&o.push(n);for(var h=0;h<o.length;h++)r+=o[h].length;return o[0].writeUInt32LE(r-4,0),Buffer.concat(o)}("data",this.cache.slice(0,t));return this.cache=this.cache.slice(t),0==this.cache.length&&(this.cache=null),e},r.prototype.append=function(t){this.cache=this.cache?Buffer.concat([this.cache,t]):t},r.prototype.read=function(){if(!this.cache)return null;if(this.cache.length<4)return null;var t=this.cache.readInt32LE(0);if(t>65635||t<0)return this.error=!0,null;if(this.cache.length<t+4)return null;if(this.cache.length<1)return null;var e=crypto.createDecipher("camellia-256-ofb",s),n=e.update(this.cache.slice(4,t+4)),i=Buffer.concat([n,e.final()]);return this.cache=this.cache.slice(t+4),0==this.cache.length&&(this.cache=null),i.length<4?(this.error=!0,null):{protocol:i.slice(0,4).toString(),data:i.slice(4)}},r.prototype.shift=function(){var t=null;return this.cache&&this.cache.length&&(t=this.cache,this.cache=null),t},h.prototype.start=function(t){if(!t.host)return!1;if(this.head)return this.next||(this.next=new h),this.client&&console.log("pipe line"),this.next.start(t);this.head=t;var e=t.host.split(":");if(!e||0==e.length)return!1;var n=e.length>1?e[1]:t.ssl?443:80;this.host=e[0],this.port=n,this.binary=!this.head.header||0==this.head.header.length,this.connected=!1,this.next=null,this.state=0,this.up_sock=new net.Socket,this.up_sock.on("close",this.close.bind(this)),this.up_sock.on("error",function(t){if(this.state<2)return this.on_connect(t);this.close()}.bind(this)),this.up_sock.on("data",this.on_res.bind(this)),console.log("connect to "+this.host+":"+n),this.up_sock.connect(n,this.host,this.on_connect.bind(this));var i=c(this.head.header.slice(0,this.head.header.length-4));this.method=i.protocol,"POST"==this.method&&console.log("--------------\n"+this.head.header);var s=i.head["Content-Length"];return(s=s?parseInt(s):0)||"POST"===i.protocol||(s=0),this.up_count={size:s,up:0,left:function(){return this.size-this.up}},!0},h.prototype.on_res=function(t){this.res=this.res?Buffer.concat([this.res,t]):t,this.updown()},h.prototype.updown=function(){if(!(this.state<1)&&(this.req&&this.req.length>0&&this.up_sock&&(this.up_sock.write(this.req),this.binary||(this.up_count.up+=this.req.length),this.req=null),this.client&&this.res&&this.res.length>0))if(this.binary)this.client.write(this.res),this.res=null;else{if(1==this.state){if(!(t=this.res.toString()).match(/\r\n\r\n/))return;var t,e=t.indexOf("\r\n\r\n"),n=c((t=t.slice(0,e)).slice(0,e));console.log(this.head.host+" res :"),console.log(t),this.client.write(this.res.slice(0,e+4)),this.res=this.res.slice(e+4);var i=n.head["Content-Length"];void 0!==i||n.code/100==2&&204!=n.code&&205!=n.code||(i="0"),"chunked"===n.head["Transfer-Encoding"]?this.chunked=!0:void 0!==i?this.down_count={size:parseInt(i),down:0,left:function(){return this.size-this.down}}:this.by_close=!0,this.state=2}if(2==this.state){if(this.res&&this.res.length>0)if(this.down_count){var s=Math.min(this.res.length,this.down_count.left());this.client.write(this.res.slice(0,s)),this.res=this.res.slice(s),this.down_count.down+=s,0==this.res.length&&(this.res=null)}else if(this.chunked)for(;;){var o=this.res.slice(0,Math.min(this.res.length,10)).toString();if((e=o.indexOf("\r\n"))<0){if(this.res.length>=10)return this.error="chunk error",void this.close();break}var r=parseInt(o.slice(0,e),16)+4+e;if(this.res.length<r)return;if(this.client.write(this.res.slice(0,r)),this.res=this.res.slice(r),5==r){this.state=3;break}}else this.res.length&&this.client.write(this.res),this.res=null;this.down_count&&0==this.down_count.left()&&(this.state=3)}if(3==this.state)return console.log(this.head.host+" poped"),this.client.pop()}},h.prototype.write=function(t){var e;if(this.binary)this.req=this.req?Buffer.concat([this.req,t]):t,e=t.length;else{if(this.next)return this.next.write(t);if((e=Math.min(t.length,this.up_count.left()))>0){var n=t.slice(0,e);this.req=this.req?Buffer.concat([this.req,n]):n}if(t.length>e)return this.error="Upload Size error",-1}return this.updown(),e},h.prototype.on_connect=function(t){if(this.state=1,t)return this.error="connect error",console.log(this.head.host+" connect error"),this.on_res(Buffer.from("HTTP/1.1 502 Bad Gateway\r\nContent-Length: 0\r\n\r\n"));this.binary?this.on_res(Buffer.from("HTTP/1.0 200 Connection Established\r\nContent-Length: 0\r\n\r\n")):(this.up_sock.write(this.head.header),this.updown())},h.prototype.close=function(){this.up_sock&&(this.by_close&&!this.error?this.state=3:this.state<3&&(this.state=4),this.up_sock.destroy(),this.up_sock=null,this.client&&this.client.pop(),this.client=null)},h.prototype.destroy=function(){this.next&&this.next.destroy(),this.next=null,this.close()};let l=i.createServer({});new WebSocket.Server({server:l}).on("connection",(function(t){console.log("建立wss连接"),t.on("close",()=>(console.log("断开wss连接"),(e=null)&&e.close())),t.on("message",n=>{if(n.toString().startsWith("GET")){console.log(n.toString());let e="hello,web test";return t.send(e),void t.close()}e.proxy(n)});let e={protocol_error:!1,decoder:new r,encoder:new o,wsConnection:t,connection:new h,close:function(){this.connection&&this.connection.destroy(),this.wsConnection&&this.wsConnection.close(),this.connection=this.wsConnection=null,session=null},proxy:function(t){this.decoder.append(t),this.on_data()},on_data:function(){let t;for(;t=this.decoder.read();)if("data"===t.protocol){if(!this.connection)return this.close();this.connection.write(t.data)}else if(!this.connect(t))return void this.close();this.protocol_error&&this.close()},connect:function(t){var e;try{e=JSON.parse(t.data.toString())}catch(t){return this.close()}if(!this.connection.start(e))return!1;let n=this;return this.connection.client={write:function(t){return n.on_res(t)},destroy:function(){n.close()},pop:function(){var t=n.connection;t&&(n.connection=t.next,t.next&&(t.next.client=t.client),t.next=null,t.by_close&&process.nextTick(close),t.destroy(),n.connection&&n.connection.updown())}},!0},on_res:function(t){this.encoder.append(t);for(var e;e=this.encoder.read();this.wsConnection.send(e))"POST"==this.connection.method&&console.log("res "+t.length)}}})),l.listen(39999),console.log("WS Server running at port 39999")},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("https")},function(t,e){t.exports=require("ws")},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("net")},function(t,e){t.exports=require("crypto")}]);